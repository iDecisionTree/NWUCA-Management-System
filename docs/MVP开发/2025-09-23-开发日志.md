# 开发日志 - 2025年9月23日

## 核心目标

完成Epic1、**Epic 2: 组织与人员管理** 的后端功能开发，建立一个基于角色的权限系统，并实现对核心数据模型（部门、职务、会员、任期）的增删改查（CRUD）操作。

## 完成内容

### 1. 权限系统与认证 (Authentication & Authorization)

- **用户模型扩展**:

  - 在 `internal/model/model.go` 的 `User` 结构体中增加了 `Role` 字段，用于区分 `admin` 和 `member` 等不同角色。
- **JWT 令牌增强**:

  - 更新了 `internal/util/auth/jwt.go` 中的 `GenerateToken` 函数和 `Claims` 结构体。
  - 现在生成的 JWT 令牌中会包含 `user_id` 和 `role` 信息，为后续的权限控制提供了必要的数据。
- **认证中间件 (`AuthMiddleware`)**:

  - 创建了 `internal/middleware/auth_middleware.go`。
  - 此中间件负责检查所有受保护路由的 `Authorization` 请求头，验证 "Bearer" 令牌的有效性。
  - 验证通过后，会将 `userID` 和 `userRole` 存入 Gin 的上下文中，供后续处理程序使用。
- **角色权限中间件 (`RoleAuthMiddleware`)**:

  - 创建了 `internal/middleware/role_middleware.go`。
  - 这是一个中间件工厂，可以根据传入的 `requiredRole`（如 "admin"）生成一个特定的权限检查器。
  - 它会从上下文中读取 `userRole`，并判断用户是否拥有访问该路由所需的权限。

### 2. 部门管理 (Department)

- **分层实现**: 创建了 `DepartmentRepository`, `DepartmentService`, 和 `DepartmentHandler`。
- **API 端点**:
  - `GET /api/v1/departments`: 获取所有部门列表（所有认证用户可访问）。
  - `POST /api/v1/departments`: 创建新部门（仅限 `admin`）。
  - `PUT /api/v1/departments/:id`: 更新指定部门（仅限 `admin`）。
  - `DELETE /api/v1/departments/:id`: 删除指定部门（仅限 `admin`）。

### 3. 职务管理 (Position)

- **分层实现**: 创建了 `PositionRepository`, `PositionService`, 和 `PositionHandler`。
- **API 端点**:
  - `GET /api/v1/positions`: 获取所有职务列表（所有认证用户可访问）。
  - `POST /api/v1/positions`: 创建新职务（仅限 `admin`）。
  - `PUT /api/v1/positions/:id`: 更新指定职务（仅限 `admin`）。
  - `DELETE /api/v1/positions/:id`: 删除指定职务（仅限 `admin`）。

### 4. 会员管理 (Member)

- **分层实现**: 创建了 `MemberRepository`, `MemberService`, 和 `MemberHandler`。
- **事务处理**:
  - 创建会员时，在单个数据库事务中同时创建关联的 `User` 和 `Member` 记录，保证数据一致性。
  - 删除会员时，同样在事务中删除 `Member` 及其关联的 `User`。
- **数据预加载**: 查询会员信息时，使用 GORM 的 `Preload("User")` 自动加载关联的用户数据，提高了 API 效率和便利性。
- **API 端点**:
  - `GET /api/v1/members`: 获取所有会员列表（所有认证用户可访问）。
  - `POST /api/v1/members`: 创建新会员及其登录账号（仅限 `admin`）。
  - `PUT /api/v1/members/:id`: 更新会员档案信息（仅限 `admin`）。
  - `DELETE /api/v1/members/:id`: 删除会员及其登录账号（仅限 `admin`）。

### 5. 任期分配 (Assignment)

- **分层实现**: 创建了 `AssignmentRepository`, `AssignmentService`, 和 `AssignmentHandler`。
- **数据预加载**: 查询任期信息时，使用 `Preload` 同时加载关联的 `Member`, `Department`, 和 `Position` 的详细信息。
- **可空字段**: `EndDate` 字段设计为可空，以支持表示“在任”状态。
- **API 端点**:
  - `GET /api/v1/assignments`: 获取所有任期记录（所有认证用户可访问）。
  - `POST /api/v1/assignments`: 分配新任期（仅限 `admin`）。
  - `PUT /api/v1/assignments/:id`: 更新任期信息（仅限 `admin`）。
  - `DELETE /api/v1/assignments/:id`: 删除任期记录（仅限 `admin`）。

## 总结

今天完成了 Epic 2 的全部后端开发任务。系统现在拥有一个功能完备、权限分明的组织与人员管理模块。所有写操作（创建、更新、删除）都受到管理员权限保护，而读操作则对所有登录用户开放。代码遵循了依赖注入和分层架构的最佳实践，并恰当运用了事务处理和数据预加载等技术。
